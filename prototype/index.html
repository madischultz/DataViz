<!DOCTYPE html>
<html>

<head>
    <title>A Blockly Data Visualization</title>
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="https://unpkg.com/blockly/python_compressed"></script>
    <script src="custom_blocks.js"></script>
    <link rel="stylesheet" type="text/css" href="styles.css">
</head>

<body>
    <div>
        <p>
            <a href="https://github.com/madischultz/DataViz/blob/main/prototype/custom_blocks.js" target="_blank">
                <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub Logo"
                    width="20" height="20">
                View Source on GitHub
            </a>
        </p>
    </div>
    <div class="row">
        <div id="blocklyDiv" class="full-width"></div>
        <xml id="toolbox" style="display: none">
            <category name="Data" colour="#995ba5">
                <block type="dataframe"></block>
                <block type="import"></block>
                <block type="export"></block>
                <block type="remove_null"></block>
            </category>

            <category name="Plots" colour="green">
                <block type="canvas"></block>
                <block type="plot_one"></block>
                <block type="plot_2d"></block>
            </category>
            <category name="Visuals (cosmetics, themes)" colour="blue">
                <block type="themes"></block>
            </category>
            <category name="Models" colour="red"></category>

        </xml>
    </div>
    <div class="row button-row">
        <button onclick="generatePythonCode()">Generate Python</button>
        <button onclick="savePythonCode()">Save Python</button>
        <button onclick="runPythonCode()">Run Python</button> <!-- This button should display a plot -->
        <button onclick="generateCode()">Generate JavaScript</button>
        <button onclick="runCode()">Run JavaScript</button>
        <button onclick="saveBlocks()">Save Blocks</button>
        <button onclick="loadBlocks()">Load Blocks</button>
        <button id="showPlotBtn">Show Plot</button> <!-- New Button -->
        <input type="file" id="loadInput" style="display: none;" onchange="loadBlocksFile(event)">
    </div>
    <div class="row">
        <div id="codeDiv" class="half-width"></div>
        <div id="outputDiv" class="half-width"></div>
    </div>
    <div id="plotModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <img src="plot.png" alt="ggplot Plot">
        </div>
    </div>
    <script>
        var workspace = Blockly.inject('blocklyDiv', {
            toolbox: document.getElementById('toolbox'),
            scrollbars: true
        });

        function generatePythonCode() {
            var code = Blockly.Python.workspaceToCode(workspace); // Change JavaScript to Python
            document.getElementById('codeDiv').innerText = code;
        }

        function savePythonCode() {
            var code = Blockly.Python.workspaceToCode(workspace);
            var blob = new Blob([code], { type: 'text/plain' });
            var a = document.createElement('a');
            a.download = 'generated_code.py';
            a.href = URL.createObjectURL(blob);
            a.click();
        }

        function runPythonCode() {
        //     var pythonCode = Blockly.Python.workspaceToCode(workspace);

        //     // Sending a POST request to the Flask server with the Python code
        //     fetch('https://austintsimpson4.pythonanywhere.com/execute-code', {
        //         method: 'POST',
        //         headers: {
        //             'Content-Type': 'application/json'
        //         },
        //         body: JSON.stringify({ code: pythonCode })
        //     })
        //         .then(response => response.json())
        //         .then(data => {
        //             // Displaying the result from the Flask server in outputDiv
        //             document.getElementById('outputDiv').innerText = data.result;
        //         })
        //         .catch(error => {
        //             // Handling errors
        //             document.getElementById('outputDiv').innerText = 'Error: ' + error;
        //         });
        // }

        var pythonCode = python.pythonGenerator.workspaceToCode(workspace);
        try {
            var output = eval(pythonCode);
            document.getElementById('outputDiv').innerText = output;
        } catch (e) {
            document.getElementById('outputDiv').innerText = 'Error: ' + e;
        }


        }

        // function runPythonCode() {
        //     const pythonCode = python.pythonGenerator.workspaceToCode(workspace);
        //     console.log(pythonCode)
        //     try {
        //         var output = eval(pythonCode);
        //         document.getElementById('outputDiv').innerText = output;
        //     } catch (e) {
        //         document.getElementById('outputDiv').innerText = 'Error: ' + e;
        //     }
        // }

        function generateCode() {
            var code = Blockly.JavaScript.workspaceToCode(workspace);
            document.getElementById('codeDiv').innerText = code;
        }

        function runCode() {
            var code = Blockly.JavaScript.workspaceToCode(workspace);
            try {
                var output = eval(code);
                document.getElementById('outputDiv').innerText = output;
            } catch (e) {
                document.getElementById('outputDiv').innerText = 'Error: ' + e;
            }
        }


        function saveBlocks() {
            var xml = Blockly.Xml.workspaceToDom(workspace);
            var xmlText = Blockly.Xml.domToPrettyText(xml);
            var blob = new Blob([xmlText], { type: 'text/xml' });
            var a = document.createElement('a');
            a.download = 'blocks.xml';
            a.href = URL.createObjectURL(blob);
            a.click();
        }

        function loadBlocks() {
            document.getElementById('loadInput').click();
        }

        function loadBlocksFile(event) {
            var file = event.target.files[0];
            var reader = new FileReader();
            reader.onload = function (e) {
                var xml = Blockly.utils.xml.textToDom(e.target.result);
                Blockly.Xml.appendDomToWorkspace(xml, workspace);
            };
            reader.readAsText(file);
        }
        document.getElementById("showPlotBtn").addEventListener("click", function () {
            document.getElementById("plotModal").style.display = "block";
        });

        document.getElementsByClassName("close")[0].addEventListener("click", function () {
            document.getElementById("plotModal").style.display = "none";
        });
    </script>
</body>

</html>